<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>색상 코드 변환기</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- Common header will be injected here -->

    <main>
        <section id="color-code-converter" class="page-section active">
            <div class="content-container">
                <h2>색상 코드 변환기</h2>
                <div class="tool-card">
                    <div class="preview-box mx-auto" id="color-preview"></div>
                    <form id="converter-form">
                        <fieldset>
                            <legend>색상 값</legend>
                            <div class="input-group color-input-group">
                                <label for="hex-input">HEX</label>
                                <input type="text" id="hex-input" placeholder="#RRGGBB">
                            </div>
                            <div class="input-group color-input-group">
                                <label for="rgb-input">RGB</label>
                                <input type="text" id="rgb-input" placeholder="R, G, B">
                            </div>
                            <div class="input-group color-input-group">
                                <label for="hsl-input">HSL</label>
                                <input type="text" id="hsl-input" placeholder="H, S, L">
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div id="tool-description" class="tool-card" style="display: none;"></div>
            </div>
        </section>
    </main>

    <!-- Common footer will be injected here -->

    <script type="module">
        import { createHeader, createFooter } from '../../assets/js/common-components.js';
        import { initTheme } from '../../assets/js/modules/theme.js';

        document.body.prepend(createHeader());
        document.body.append(createFooter());

        function initColorCodeConverter() {
            // 1. DOM Elements
            const preview = document.getElementById('color-preview');
            const hexInput = document.getElementById('hex-input');
            const rgbInput = document.getElementById('rgb-input');
            const hslInput = document.getElementById('hsl-input');

            // 2. Event Listeners
            hexInput.addEventListener('input', (e) => updateColor('hex', e.target.value));
            rgbInput.addEventListener('input', (e) => updateColor('rgb', e.target.value));
            hslInput.addEventListener('input', (e) => updateColor('hsl', e.target.value));

            // 3. Functions
            function updateColor(source, value) {
                let r=0, g=0, b=0;

                try {
                    if (source === 'hex') {
                        [r, g, b] = hexToRgb(value) || [0,0,0];
                    } else if (source === 'rgb') {
                        [r, g, b] = parseRgb(value) || [0,0,0];
                    } else if (source === 'hsl') {
                        const hsl = parseHsl(value);
                        if(hsl) [r, g, b] = hslToRgb(...hsl);
                    }

                    if (source !== 'hex') hexInput.value = rgbToHex(r, g, b);
                    if (source !== 'rgb') rgbInput.value = `${r}, ${g}, ${b}`;
                    if (source !== 'hsl') {
                        const [h, s, l] = rgbToHsl(r, g, b);
                        hslInput.value = `${h}, ${s}%, ${l}%`;
                    }
                    
                    preview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                } catch (e) {
                    console.error("Color conversion error:", e);
                }
            }

            const parseRgb = (rgbStr) => rgbStr.split(',').map(c => parseInt(c.trim()));
            const parseHsl = (hslStr) => hslStr.split(',').map(c => parseInt(c.trim()));

            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? [ parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16) ] : null;
            }

            function rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
            }

            function rgbToHsl(r, g, b) {
                r /= 255, g /= 255, b /= 255;
                let max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                if (max == min) { h = s = 0; } 
                else {
                    let d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
            }

            function hslToRgb(h, s, l) {
                s /= 100; l /= 100;
                let c = (1 - Math.abs(2 * l - 1)) * s, x = c * (1 - Math.abs((h / 60) % 2 - 1)), m = l - c/2, r=0, g=0, b=0;
                if (0 <= h && h < 60) { [r,g,b] = [c,x,0]; } 
                else if (60 <= h && h < 120) { [r,g,b] = [x,c,0]; } 
                else if (120 <= h && h < 180) { [r,g,b] = [0,c,x]; } 
                else if (180 <= h && h < 240) { [r,g,b] = [0,x,c]; } 
                else if (240 <= h && h < 300) { [r,g,b] = [x,0,c]; } 
                else if (300 <= h && h < 360) { [r,g,b] = [c,0,x]; }
                r = Math.round((r + m) * 255); g = Math.round((g + m) * 255); b = Math.round((b + m) * 255);
                return [r, g, b];
            }

            // Initial color
            updateColor('hex', '#4A90E2');
        }

        async function loadDescription() {
            const descriptionEl = document.getElementById('tool-description');
            try {
                const response = await fetch('./description.md');
                if (!response.ok) return;
                const markdown = await response.text();
                descriptionEl.innerHTML = marked.parse(markdown);
                descriptionEl.style.display = 'block';
            } catch (error) {
                console.error('Error loading description:', error);
                descriptionEl.style.display = 'none';
            }
        }

        initTheme();
        initColorCodeConverter();
        loadDescription();
    </script>
</body>
</html>
