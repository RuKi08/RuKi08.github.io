<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Box</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <header>
        <div class="logo">Secret Box</div>
        <button id="theme-toggle">☀️</button>
    </header>

    <main>
        <section id="secret-box" class="page-section active">
            <div class="tool-card text-center">
                <p>전 세계 누구나 데이터와 '비밀키'를 남기고, 다른 사람들의 데이터를 볼 수 있는 공간입니다.</p>
                <form id="secret-form">
                    <textarea id="secret-data" placeholder="여기에 데이터를 입력하세요..." rows="4"></textarea>
                    <input type="password" id="secret-key" placeholder="해독암호 (비밀키)">
                    <button type="submit" id="save-secret" class="w-100">저장하기</button>
                </form>
                <div class="secret-display mt-2">
                    <button id="load-secrets" class="w-100">모든 데이터 보기</button>
                    <ul id="secret-list" class="preview-box"></ul>
                </div>
            </div>
            <div id="tool-description" class="tool-card" style="display: none;"></div>
        </section>
    </main>

    <script type="module">
        import { db } from '../../assets/js/firebase-config.js';
        import { collection, addDoc, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { initTheme } from '../../assets/js/modules/theme.js';

        function initSecretBox() {
            // 1. DOM Elements
            const form = document.getElementById('secret-form');
            const secretDataInput = document.getElementById('secret-data');
            const secretKeyInput = document.getElementById('secret-key');
            const loadSecretsBtn = document.getElementById('load-secrets');
            const secretList = document.getElementById('secret-list');

            // 2. Firebase Check
            if (!db) {
                console.error("Firestore DB 객체를 찾을 수 없습니다. firebase-config.js를 확인하세요.");
                form.querySelector('button').disabled = true;
                loadSecretsBtn.disabled = true;
                return;
            }

            // 3. Event Listeners
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveSecret();
            });
            loadSecretsBtn.addEventListener('click', loadSecrets);

            // 4. Functions
            async function saveSecret() {
                const data = secretDataInput.value;
                const key = secretKeyInput.value;

                if (!data || !key) {
                    alert('데이터와 비밀키를 모두 입력해주세요.');
                    return;
                }

                try {
                    await addDoc(collection(db, 'secrets'), {
                        data: data,
                        key: key,
                        timestamp: serverTimestamp()
                    });
                    alert('데이터가 성공적으로 저장되었습니다!');
                    secretDataInput.value = '';
                    secretKeyInput.value = '';
                    loadSecrets(); // Refresh the list
                } catch (e) {
                    console.error("데이터 저장 중 오류 발생: ", e);
                    alert('데이터 저장에 실패했습니다. 콘솔을 확인하세요.');
                }
            }

            async function loadSecrets() {
                secretList.innerHTML = '<li>로딩 중...</li>';

                try {
                    const q = query(collection(db, 'secrets'), orderBy('timestamp', 'desc'));
                    const querySnapshot = await getDocs(q);

                    secretList.innerHTML = '';
                    if (querySnapshot.empty) {
                        secretList.innerHTML = '<li>아직 저장된 비밀 데이터가 없습니다.</li>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const secret = doc.data();
                        const listItem = document.createElement('li');
                        listItem.textContent = secret.data;
                        secretList.appendChild(listItem);
                    });
                } catch (e) {
                    console.error("데이터 로드 중 오류 발생: ", e);
                    secretList.innerHTML = '<li>데이터를 불러오는 데 실패했습니다.</li>';
                }
            }
        }

        async function loadDescription() {
            const descriptionEl = document.getElementById('tool-description');
            try {
                const response = await fetch('./description.md');
                if (!response.ok) return;
                const markdown = await response.text();
                descriptionEl.innerHTML = marked.parse(markdown);
                descriptionEl.style.display = 'block';
            } catch (error) {
                console.error('Error loading description:', error);
                descriptionEl.style.display = 'none';
            }
        }
        
        initTheme();
        initSecretBox();
        loadDescription();
    </script>
</body>
</html>