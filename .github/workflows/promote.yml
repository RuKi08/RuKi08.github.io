
name: Promote and Deploy Content

on:
  issue_comment:
    types: [created]

jobs:
  promote-and-deploy:
    # Run only if the comment starts with /promote and is made by the repo owner
    if: startsWith(github.event.comment.body, '/promote') && github.actor == github.repository_owner
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pages: write
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Get Type and Slug
        id: issue_data
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Get Content Type from Label
            const labels = context.payload.issue.labels;
            const autogenLabel = labels.find(label => label.name.startsWith('autogen:'));
            if (!autogenLabel) {
              core.setFailed('Could not find an "autogen:" label on the issue.');
              return;
            }
            const type = autogenLabel.name.split(':')[1];
            core.setOutput('type', type);

            // 2. Get Slug from Bot Comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.reverse().find(
              comment => comment.user.login === 'github-actions[bot]' && comment.body.includes('<!-- slug:')
            );

            if (!botComment) {
              core.setFailed('Could not find a slug from a previous bot comment.');
              return;
            }

            const match = botComment.body.match(/<!-- slug:(.*?) -->/);
            if (!match || !match[1]) {
              core.setFailed('Could not parse slug from bot comment.');
              return;
            }
            const slug = match[1];
            core.setOutput('slug', slug);

      - name: Create Firebase Service Account Key
        env:
          FIREBASE_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        run: echo "$FIREBASE_KEY" > serviceAccountKey.json

      - name: Run Promotion Script
        run: node scripts/promote.js ${{ steps.issue_data.outputs.type }} ${{ steps.issue_data.outputs.slug }}

      - name: Post Promotion Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Promotion script finished for **${{ steps.issue_data.outputs.slug }}**. Starting final build and deployment...`
            });

      # --- Build and Deploy Steps (copied from deploy.yml) ---
      - name: Build website
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Post Deployment Comment & Close Issue
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = `${{ steps.deployment.outputs.page_url }}`;
            const body = `ðŸš€ Successfully deployed to ${deployUrl}\n\nAll steps complete.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });

