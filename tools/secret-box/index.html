<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Box</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="../../assets/js/firebase-config.js" type="module"></script>
    <script type="module">
        import { db } from '../../assets/js/firebase-config.js';
        import { collection, addDoc, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        function initSecretBox() {
            if (!db) {
                console.error("Firestore DB 객체를 찾을 수 없습니다. firebase-config.js를 확인하세요.");
                // Firebase가 초기화되지 않았다면 SecretBox 기능 비활성화
                const saveBtn = document.getElementById('save-secret');
                const loadBtn = document.getElementById('load-secrets');
                if(saveBtn) saveBtn.disabled = true;
                if(loadBtn) loadBtn.disabled = true;
                return;
            }

            const secretDataInput = document.getElementById('secret-data');
            const secretKeyInput = document.getElementById('secret-key');
            const saveSecretBtn = document.getElementById('save-secret');
            const loadSecretsBtn = document.getElementById('load-secrets');
            const secretList = document.getElementById('secret-list');

            if (!saveSecretBtn) return; // SecretBox 섹션이 없을 경우 중단

            saveSecretBtn.addEventListener('click', async () => {
                const data = secretDataInput.value;
                const key = secretKeyInput.value;

                if (!data) {
                    alert('데이터를 입력해주세요.');
                    return;
                }
                if (!key) {
                    alert('비밀키를 입력해주세요.');
                    return;
                }

                try {
                    const docRef = await addDoc(collection(db, 'secrets'), {
                        data: data,
                        key: key,
                        timestamp: serverTimestamp()
                    });
                    alert('데이터가 성공적으로 저장되었습니다! 문서 ID: ' + docRef.id);
                    secretDataInput.value = '';
                    secretKeyInput.value = '';
                    loadSecretsBtn.click();
                } catch (e) {
                    console.error("데이터 저장 중 오류 발생: ", e);
                    alert('데이터 저장에 실패했습니다. 콘솔을 확인하세요.');
                }
            });

            loadSecretsBtn.addEventListener('click', async () => {
                secretList.innerHTML = '';

                try {
                    const q = query(collection(db, 'secrets'), orderBy('timestamp', 'desc'));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        secretList.innerHTML = '<li>아직 저장된 비밀 데이터가 없습니다.</li>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const secret = doc.data();
                        const listItem = document.createElement('li');
                        listItem.textContent = secret.data;
                        secretList.appendChild(listItem);
                    });
                    alert('데이터를 성공적으로 불러왔습니다.');
                } catch (e) {
                    console.error("데이터 로드 중 오류 발생: ", e);
                    alert('데이터 로드에 실패했습니다. 콘솔을 확인하세요.');
                }
            });
        }

        // Initialize the theme toggle and the secret box functionality
        import { initTheme } from '../../assets/js/modules/theme.js';
        initTheme();
        initSecretBox();
    </script>
</head>
<body>
    <header>
        <div class="logo">Secret Box</div>
        <button id="theme-toggle">☀️</button>
    </header>

    <main>
        <section id="secret-box" class="page-section active">
            <p>전 세계 누구나 데이터와 '비밀키'를 남기고, 다른 사람들의 데이터를 볼 수 있는 공간입니다.</p>
            <div class="secret-form">
                <textarea id="secret-data" placeholder="여기에 데이터를 입력하세요..."></textarea>
                <input type="password" id="secret-key" placeholder="해독암호 (비밀키)">
                <button id="save-secret">저장하기</button>
            </div>
            <div class="secret-display">
                <button id="load-secrets">모든 데이터 보기</button>
                <ul id="secret-list"></ul>
            </div>
        </section>
    </main>
</body>
</html>