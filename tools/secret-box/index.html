<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Box</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        .tool-card {
            background-color: var(--background-secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            max-width: 800px;
            margin: 2rem auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #secret-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        #secret-list li { padding: 0.5rem; border-bottom: 1px solid var(--border-color); }
        #secret-list li:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <header>
        <div class="logo">Secret Box</div>
        <button id="theme-toggle">☀️</button>
    </header>

    <main>
        <section id="secret-box" class="page-section active">
            <div class="tool-card">
                <p style="text-align: center; margin-bottom: 1.5rem;">전 세계 누구나 데이터와 '비밀키'를 남기고, 다른 사람들의 데이터를 볼 수 있는 공간입니다.</p>
                <div class="secret-form">
                    <textarea id="secret-data" placeholder="여기에 데이터를 입력하세요..." rows="4"></textarea>
                    <input type="password" id="secret-key" placeholder="해독암호 (비밀키)" style="margin-top: 1rem;">
                    <button id="save-secret" style="width: 100%; margin-top: 1rem;">저장하기</button>
                </div>
                <div class="secret-display" style="margin-top: 2rem;">
                    <button id="load-secrets" style="width: 100%;">모든 데이터 보기</button>
                    <ul id="secret-list"></ul>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { db } from '../../assets/js/firebase-config.js';
        import { collection, addDoc, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { initTheme } from '../../assets/js/modules/theme.js';
        initTheme();

        function initSecretBox() {
            if (!db) {
                console.error("Firestore DB 객체를 찾을 수 없습니다. firebase-config.js를 확인하세요.");
                const saveBtn = document.getElementById('save-secret');
                const loadBtn = document.getElementById('load-secrets');
                if(saveBtn) saveBtn.disabled = true;
                if(loadBtn) loadBtn.disabled = true;
                return;
            }

            const secretDataInput = document.getElementById('secret-data');
            const secretKeyInput = document.getElementById('secret-key');
            const saveSecretBtn = document.getElementById('save-secret');
            const loadSecretsBtn = document.getElementById('load-secrets');
            const secretList = document.getElementById('secret-list');

            if (!saveSecretBtn) return;

            saveSecretBtn.addEventListener('click', async () => {
                const data = secretDataInput.value;
                const key = secretKeyInput.value;

                if (!data || !key) {
                    alert('데이터와 비밀키를 모두 입력해주세요.');
                    return;
                }

                try {
                    await addDoc(collection(db, 'secrets'), {
                        data: data,
                        key: key,
                        timestamp: serverTimestamp()
                    });
                    alert('데이터가 성공적으로 저장되었습니다!');
                    secretDataInput.value = '';
                    secretKeyInput.value = '';
                    loadSecretsBtn.click();
                } catch (e) {
                    console.error("데이터 저장 중 오류 발생: ", e);
                    alert('데이터 저장에 실패했습니다. 콘솔을 확인하세요.');
                }
            });

            loadSecretsBtn.addEventListener('click', async () => {
                secretList.innerHTML = '<li>로딩 중...</li>';

                try {
                    const q = query(collection(db, 'secrets'), orderBy('timestamp', 'desc'));
                    const querySnapshot = await getDocs(q);

                    secretList.innerHTML = '';
                    if (querySnapshot.empty) {
                        secretList.innerHTML = '<li>아직 저장된 비밀 데이터가 없습니다.</li>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const secret = doc.data();
                        const listItem = document.createElement('li');
                        listItem.textContent = secret.data;
                        secretList.appendChild(listItem);
                    });
                } catch (e) {
                    console.error("데이터 로드 중 오류 발생: ", e);
                    alert('데이터 로드에 실패했습니다. 콘솔을 확인하세요.');
                }
            });
        }
        
        initSecretBox();
    </script>
</body>
</html>